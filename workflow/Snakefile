import os
import glob
import re
import sys
import pandas as pd
import snakemake
import git

# Check correct snakemake version is being used.
try: snakemake.utils.min_version("6.5.3")
except snakemake.exceptions.WorkflowError as e:
    print(e, "Workflow aborted.")
    sys.exit()

# Setup config file
configfile: "../config/config.yaml"
if not os.path.isfile("../config/config.yaml"):
    print("Configuration file (config/config.yaml) not found. Workflow aborted.")
    sys.exit()
# Setup report destination
report: "report/workflow.rst"

snakemake.utils.validate(config, schema="schemas/config.schema.yaml")

# Load RRBS sample sheet
rrbs_samples = pd.read_table(config["RRBS_samples"])
snakemake.utils.validate(rrbs_samples, schema="schemas/samples.schema.yaml")

# Install DMRFinder from github if not done already
DMRFinder_repo_path = "../resources/DMRFinder"
if not os.path.isdir(DMRFinder_repo_path):
    git.Repo.clone_from(config["DMRfinder"]["DMRFinder_git_URL"], DMRFinder_repo_path)
DMRFinder_repo = git.Repo(DMRFinder_repo_path)
# check that the repository loaded correctly
if DMRFinder_repo.bare:
    print('Could not load repository at {}. Recommend checking DMRFinder git url in ../config/config.yaml. Workflow aborted.'.format(DMRFinder_repo_path))


# Load rules
#include: "rules/common.smk"
#include: "rules/ref.smk"
#include: "rules/trim.smk"
#include: "rules/qc.smk"
#include: "rules/align.smk"
#include: "rules/diffexp.smk"
